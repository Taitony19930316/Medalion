{% extends "base.html" %}

{% block title %}股票分析 - 量化交易分析系统{% endblock %}

{% block extra_head %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    
    .indicator-card {
        transition: transform 0.2s;
    }
    
    .indicator-card:hover {
        transform: translateY(-2px);
    }
    
    .fractal-point {
        font-size: 12px;
        font-weight: bold;
    }
    
    .stroke-line {
        stroke-width: 2;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 股票搜索 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <form id="analysisForm" class="row g-3">
                    <div class="col-md-6">
                        <label for="symbolInput" class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="symbolInput" 
                               placeholder="输入股票代码 (如: 000001)" maxlength="6">
                    </div>
                    <div class="col-md-4">
                        <label for="periodSelect" class="form-label">分析周期</label>
                        <select class="form-select" id="periodSelect">
                            <option value="60">60天</option>
                            <option value="120" selected>120天</option>
                            <option value="250">250天</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>
                            分析
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 加载状态 -->
<div id="loadingSection" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">分析中...</span>
    </div>
    <h5>正在分析股票数据...</h5>
    <p class="text-muted">请稍候，这可能需要几秒钟时间</p>
</div>

<!-- 分析结果 -->
<div id="analysisResults" style="display: none;">
    <!-- 股票基本信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-1">
                                <span id="stockName">股票名称</span>
                                <small class="text-muted" id="stockCode"></small>
                            </h4>
                            <div class="d-flex align-items-center">
                                <span class="h3 mb-0 me-3" id="currentPrice">¥0.00</span>
                                <span id="priceChange" class="badge fs-6">+0.00%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="text-muted small">成交量</div>
                                    <div class="fw-bold" id="volume">0</div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted small">RSI</div>
                                    <div class="fw-bold" id="rsiValue">0</div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted small">趋势</div>
                                    <div class="fw-bold" id="trendDirection">未知</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="chartTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="kline-tab" data-bs-toggle="tab" 
                                    data-bs-target="#kline-pane" type="button" role="tab">
                                K线图
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="macd-tab" data-bs-toggle="tab" 
                                    data-bs-target="#macd-pane" type="button" role="tab">
                                MACD
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rsi-tab" data-bs-toggle="tab" 
                                    data-bs-target="#rsi-pane" type="button" role="tab">
                                RSI
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="chartTabContent">
                        <div class="tab-pane fade show active" id="kline-pane" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="klineChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="macd-pane" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="macdChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="rsi-pane" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="rsiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析结果 -->
    <div class="row">
        <!-- 缠论分析 -->
        <div class="col-lg-6 mb-4">
            <div class="card indicator-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        缠论分析
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="text-muted small">分型数量</div>
                                <div class="h4 mb-0" id="fractalCount">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="text-muted small">笔段数量</div>
                                <div class="h4 mb-0" id="strokeCount">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>最近分型:</span>
                            <span id="recentFractal" class="fw-bold">无</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>最近笔段:</span>
                            <span id="recentStroke" class="fw-bold">无</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" id="changlunSummary">
                        缠论分析结果将在这里显示...
                    </div>
                </div>
            </div>
        </div>

        <!-- 技术指标 -->
        <div class="col-lg-6 mb-4">
            <div class="card indicator-card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        技术指标
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-4 text-center">
                            <div class="text-muted small">MA5</div>
                            <div class="fw-bold" id="ma5Value">0.00</div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="text-muted small">MA20</div>
                            <div class="fw-bold" id="ma20Value">0.00</div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="text-muted small">MA60</div>
                            <div class="fw-bold" id="ma60Value">0.00</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6 text-center">
                            <div class="text-muted small">MACD</div>
                            <div class="fw-bold" id="macdValue">0.0000</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="text-muted small">信号线</div>
                            <div class="fw-bold" id="macdSignalValue">0.0000</div>
                        </div>
                    </div>
                    
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" id="rsiProgress" 
                             style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                            RSI: 50
                        </div>
                    </div>
                    
                    <div id="technicalSummary" class="alert alert-success">
                        技术指标分析结果将在这里显示...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易建议 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        交易建议
                    </h5>
                </div>
                <div class="card-body">
                    <div id="tradingSuggestions">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            请先分析股票以获取交易建议
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let klineChart, macdChart, rsiChart;
let currentAnalysisData = null;

// 表单提交处理
document.getElementById('analysisForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const symbol = document.getElementById('symbolInput').value.trim();
    if (!symbol) {
        alert('请输入股票代码');
        return;
    }
    
    analyzeStock(symbol);
});

// 分析股票
function analyzeStock(symbol) {
    // 显示加载状态
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'none';
    
    // 调用API
    fetch(`/api/analyze/${symbol}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingSection').style.display = 'none';
            
            if (data.error) {
                alert('分析失败: ' + data.error);
                return;
            }
            
            currentAnalysisData = data;
            displayAnalysisResults(data);
            document.getElementById('analysisResults').style.display = 'block';
        })
        .catch(error => {
            document.getElementById('loadingSection').style.display = 'none';
            alert('网络错误: ' + error.message);
        });
}

// 显示分析结果
function displayAnalysisResults(data) {
    const summary = data.summary;
    
    // 基本信息
    document.getElementById('stockCode').textContent = `(${data.symbol})`;
    document.getElementById('stockName').textContent = `股票${data.symbol}`;
    document.getElementById('currentPrice').textContent = `¥${summary.current_price}`;
    
    // 价格变化
    const changeElement = document.getElementById('priceChange');
    const changeClass = summary.price_change >= 0 ? 'bg-success' : 'bg-danger';
    const changeSign = summary.price_change >= 0 ? '+' : '';
    changeElement.className = `badge fs-6 ${changeClass}`;
    changeElement.textContent = `${changeSign}${summary.price_change_pct.toFixed(2)}%`;
    
    // 其他信息
    document.getElementById('volume').textContent = formatNumber(summary.volume);
    document.getElementById('rsiValue').textContent = summary.rsi ? summary.rsi.toFixed(1) : 'N/A';
    
    const trendMap = {
        'strong_up': '强势上涨',
        'strong_down': '强势下跌',
        'sideways': '震荡'
    };
    document.getElementById('trendDirection').textContent = trendMap[summary.trend_strength] || '未知';
    
    // 缠论分析
    displayChanglunAnalysis(data.changlun_analysis);
    
    // 技术指标
    displayTechnicalIndicators(data);
    
    // 交易建议
    displayTradingSuggestions(summary.suggestion);
    
    // 绘制图表
    drawCharts(data);
}

// 显示缠论分析
function displayChanglunAnalysis(changlun) {
    if (!changlun || changlun.error) {
        document.getElementById('changlunSummary').innerHTML = 
            '<i class="fas fa-exclamation-triangle me-2"></i>缠论分析数据不足';
        return;
    }
    
    document.getElementById('fractalCount').textContent = changlun.fractals ? changlun.fractals.length : 0;
    document.getElementById('strokeCount').textContent = changlun.strokes ? changlun.strokes.length : 0;
    
    // 最近分型
    if (changlun.recent_fractal) {
        const fractal = changlun.recent_fractal;
        const fractalText = fractal.type === 'top' ? '顶分型' : '底分型';
        document.getElementById('recentFractal').textContent = fractalText;
    } else {
        document.getElementById('recentFractal').textContent = '无';
    }
    
    // 最近笔段
    if (changlun.recent_stroke) {
        const stroke = changlun.recent_stroke;
        const strokeText = stroke.direction === 'up' ? '上涨笔' : '下跌笔';
        document.getElementById('recentStroke').textContent = strokeText;
    } else {
        document.getElementById('recentStroke').textContent = '无';
    }
    
    // 分析摘要
    const summary = changlun.analysis_summary;
    if (summary) {
        let summaryText = `趋势方向: ${summary.trend_direction || '未知'}`;
        if (summary.trend_strength) {
            summaryText += `，趋势强度: ${(summary.trend_strength * 100).toFixed(1)}%`;
        }
        document.getElementById('changlunSummary').innerHTML = 
            `<i class="fas fa-chart-area me-2"></i>${summaryText}`;
    }
}

// 显示技术指标
function displayTechnicalIndicators(data) {
    const indicators = data.indicators;
    
    // 移动平均线
    if (indicators.ma5 && indicators.ma5.length > 0) {
        const latestMA5 = indicators.ma5[indicators.ma5.length - 1];
        document.getElementById('ma5Value').textContent = latestMA5.value.toFixed(2);
    }
    
    if (indicators.ma20 && indicators.ma20.length > 0) {
        const latestMA20 = indicators.ma20[indicators.ma20.length - 1];
        document.getElementById('ma20Value').textContent = latestMA20.value.toFixed(2);
    }
    
    if (indicators.ma60 && indicators.ma60.length > 0) {
        const latestMA60 = indicators.ma60[indicators.ma60.length - 1];
        document.getElementById('ma60Value').textContent = latestMA60.value.toFixed(2);
    }
    
    // MACD
    if (indicators.macd) {
        const macd = indicators.macd;
        if (macd.macd && macd.macd.length > 0) {
            const latestMACD = macd.macd[macd.macd.length - 1];
            document.getElementById('macdValue').textContent = latestMACD.value.toFixed(4);
        }
        
        if (macd.signal && macd.signal.length > 0) {
            const latestSignal = macd.signal[macd.signal.length - 1];
            document.getElementById('macdSignalValue').textContent = latestSignal.value.toFixed(4);
        }
    }
    
    // RSI进度条
    const rsi = data.summary.rsi;
    if (rsi) {
        const rsiProgress = document.getElementById('rsiProgress');
        rsiProgress.style.width = `${rsi}%`;
        rsiProgress.textContent = `RSI: ${rsi.toFixed(1)}`;
        
        // 根据RSI值设置颜色
        if (rsi > 80) {
            rsiProgress.className = 'progress-bar bg-danger';
        } else if (rsi < 20) {
            rsiProgress.className = 'progress-bar bg-success';
        } else {
            rsiProgress.className = 'progress-bar bg-primary';
        }
    }
    
    // 技术指标摘要
    let summaryText = '技术指标显示';
    if (data.summary.trend === '多头排列') {
        summaryText += '多头排列，趋势向上';
    } else if (data.summary.trend === '空头排列') {
        summaryText += '空头排列，趋势向下';
    } else {
        summaryText += '震荡整理，方向不明';
    }
    
    document.getElementById('technicalSummary').innerHTML = 
        `<i class="fas fa-chart-line me-2"></i>${summaryText}`;
}

// 显示交易建议
function displayTradingSuggestions(suggestions) {
    const container = document.getElementById('tradingSuggestions');
    
    if (!suggestions || suggestions.length === 0) {
        container.innerHTML = '<div class="alert alert-secondary">暂无交易建议</div>';
        return;
    }
    
    let html = '';
    suggestions.forEach((suggestion, index) => {
        const alertClass = index === 0 ? 'alert-primary' : 'alert-info';
        html += `
            <div class="alert ${alertClass}">
                <i class="fas fa-lightbulb me-2"></i>
                ${suggestion}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 绘制图表
function drawCharts(data) {
    drawKlineChart(data);
    drawMACDChart(data);
    drawRSIChart(data);
}

// 绘制K线图
function drawKlineChart(data) {
    const ctx = document.getElementById('klineChart').getContext('2d');
    
    if (klineChart) {
        klineChart.destroy();
    }
    
    const ohlcData = data.ohlc_data;
    const indicators = data.indicators;
    
    const datasets = [
        {
            label: '收盘价',
            data: ohlcData.map(item => ({x: item.date, y: item.close})),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            fill: false,
            tension: 0.1
        }
    ];
    
    // 添加移动平均线
    if (indicators.ma5) {
        datasets.push({
            label: 'MA5',
            data: indicators.ma5.map(item => ({x: item.date, y: item.value})),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'transparent',
            fill: false,
            borderWidth: 1
        });
    }
    
    if (indicators.ma20) {
        datasets.push({
            label: 'MA20',
            data: indicators.ma20.map(item => ({x: item.date, y: item.value})),
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'transparent',
            fill: false,
            borderWidth: 1
        });
    }
    
    klineChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                },
                y: {
                    beginAtZero: false
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// 绘制MACD图
function drawMACDChart(data) {
    const ctx = document.getElementById('macdChart').getContext('2d');
    
    if (macdChart) {
        macdChart.destroy();
    }
    
    const indicators = data.indicators;
    
    if (!indicators.macd) {
        return;
    }
    
    const datasets = [
        {
            label: 'MACD',
            data: indicators.macd.macd.map(item => ({x: item.date, y: item.value})),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'transparent',
            fill: false
        },
        {
            label: '信号线',
            data: indicators.macd.signal.map(item => ({x: item.date, y: item.value})),
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'transparent',
            fill: false
        }
    ];
    
    macdChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// 绘制RSI图
function drawRSIChart(data) {
    const ctx = document.getElementById('rsiChart').getContext('2d');
    
    if (rsiChart) {
        rsiChart.destroy();
    }
    
    const indicators = data.indicators;
    
    if (!indicators.rsi) {
        return;
    }
    
    rsiChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'RSI',
                data: indicators.rsi.map(item => ({x: item.date, y: item.value})),
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                },
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// 格式化数字
function formatNumber(num) {
    if (num >= 1e8) {
        return (num / 1e8).toFixed(1) + '亿';
    } else if (num >= 1e4) {
        return (num / 1e4).toFixed(1) + '万';
    } else {
        return num.toString();
    }
}

// 页面加载时检查URL参数
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get('symbol');
    
    if (symbol) {
        document.getElementById('symbolInput').value = symbol;
        analyzeStock(symbol);
    }
});
</script>
{% endblock %}